@page "/admin/users"

@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using HCMDataAccess;
@using HCMModels;
@using System.ComponentModel.DataAnnotations;


@*@inject IStringLocalizer<App> Localizer*@
@inject IUsersData _usersData;
@inject IUserRolesData _userRolesData;
@inject ILocalStorageService _storageService
@inject IStringLocalizer<HcmRes> Localizer


@attribute [Authorize]

<h3 class="title">@Localizer["Menu_Users_List"]</h3>

<div class="container">
    <div class="row row_padding blue_bg mt-3">
        <div class="col-sm-12 form-inline control_padding">
            <h5 class="mt-1">@Localizer["Administration_Users_List_Table_Title"]</h5>

        </div>

    </div>
</div>




<SfGrid DataSource="@UsersList" AllowPaging="true" AllowResizing="false" AllowTextWrap="true" Width="100%">
    <GridPageSettings PageSize="25"></GridPageSettings>
    @*<GridEvents RowDataBound="UsersList_RowDataBound" TValue="UsersModel"></GridEvents>*@
    <GridColumns>
        <GridColumn Field=@nameof(UsersModel.LoginName) HeaderText="@Localizer["Admin_Users_UserNameLabel"]" Width="0%" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Left" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left"></GridColumn>
        <GridColumn Field=@nameof(UsersModel.Name) HeaderText="@Localizer["Admin_Users_RealNameLabel"]" Width="19%"></GridColumn>
        <GridColumn Field=@nameof(UsersModel.FunctionInFirma) HeaderText="@Localizer["Admin_Users_AbteilungLabel"]" Width="25%"></GridColumn>
        <GridColumn Field=@nameof(UsersModel.EMail) HeaderText="@Localizer["Admin_Users_EmailLabel"]" Width="20%"></GridColumn>
        <GridColumn Field=@nameof(UsersModel.Status) HeaderText="@Localizer["Admin_UsersIsApprovedLabel"]" DisplayAsCheckBox="true" Width="7%" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Center"></GridColumn>
        <GridColumn HeaderText="" Width="11%" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right">
            <Template>
                @{
                    var _context = (context as UsersModel);

                    if ((_userRolesData.IsUserInRole(_userInfo.LoginName, "admin") || _userRolesData.IsUserInRole(_userInfo.LoginName, "userCreate")) || (_userInfo.LoginName == _context.LoginName))
                    {
                        <SfButton OnClick="@(()=>EditUser(_context))" IconCss="e-icons-hcm e-hcm-edit" CssClass="e-flat">@Localizer["Value_Edit_Text"]</SfButton>

                    }
                }
            </Template>

        </GridColumn>

        <GridColumn HeaderText="" Width="9%" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right">
            <Template>
                @{
                    var _context = (context as UsersModel);


                    if (_userRolesData.IsUserInRole(_userInfo.LoginName, "admin") && (_userInfo.LoginName != _context.LoginName))
                    {
                        <SfButton OnClick="@(()=>DeleteUser(_context))" IconCss="e-icons-hcm e-hcm-delete" CssClass="e-flat">@Localizer["Button_Del"]</SfButton>
                    }
                }
            </Template>
            @*<GridCommandColumns>
                    <GridCommandColumn Type="CommandButtonType.Edit" ButtonOption="@(new CommandButtonOptions() {IconCss="e-icons e-edit", CssClass="e-flat", Content=Localizer["Value_Edit_Text"]})"></GridCommandColumn>
                    <GridCommandColumn Type="CommandButtonType.Delete" ButtonOption="@(new CommandButtonOptions() {IconCss="e-icons e-delete", CssClass="e-flat", Content=Localizer["Button_Del"]})"></GridCommandColumn>
                </GridCommandColumns>*@
        </GridColumn>



    </GridColumns>
</SfGrid>

<SfDialog Header="@EditDialogHeader" @ref="EditDialogID" ShowCloseIcon="true" Width="650px" Height="820px" IsModal="true" @bind-Visible="EditDialogVisibility">
    <DialogTemplates>
        <Header>
            <h3 class="title">@Localizer["Admin_Users_EditUserTitle"]</h3>
        </Header>
        <Content>
            <div class="dialogContent">
                <h4 class="blue_bg mt-1 subtitle">@Localizer["Admin_EditUsers_GeneralData"]</h4>

                <div class="row ml-3 row_padding">
                    <div class="col-sm-12 form-inline control_padding">
                        <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_Users_UserNameLabel"]</label>
                        <div class="col-sm-6 control_padding">
                            <SfTextBox @ref="UserNameID" Placeholder="@Localizer["Admin_Users_UserNameLabel"]" Value="@_editUserInfo?.LoginName">
                            </SfTextBox>
                        </div>
                    </div>
                </div>


                <div class="row ml-3 row_padding">
                    <div class="col-sm-12 form-inline control_padding">
                        <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_Users_RealNameLabel"]</label>
                        <div class="col-sm-6 control_padding">
                            <SfTextBox @ref="RealNameID" Placeholder="@Localizer["Admin_Users_RealNameLabel"]" Value="@_editUserInfo?.Name">
                            </SfTextBox>
                        </div>
                    </div>
                </div>

                <div class="row ml-3 row_padding">
                    <div class="col-sm-12 form-inline control_padding">
                        <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_Users_EmailLabel"]</label>
                        <div class="col-sm-6 control_padding">
                            <SfTextBox @ref="EMailID" Placeholder="@Localizer["Admin_Users_EmailLabel"]" Value="@_editUserInfo?.EMail">
                            </SfTextBox>
                        </div>
                    </div>
                </div>

                <div class="row ml-3 row_padding">
                    <div class="col-sm-12 form-inline control_padding">
                        <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_Users_AbteilungLabel"]</label>
                        <div class="col-sm-6 control_padding">
                            <SfTextBox @ref="AbteilungID" Placeholder="@Localizer["Admin_Users_AbteilungLabel"]" Value="@_editUserInfo?.FunctionInFirma">
                            </SfTextBox>
                        </div>
                    </div>
                </div>

                <div class="row ml-3 row_padding">
                    <div class="col-sm-12 form-inline control_padding">
                        <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_UsersIsApprovedLabel"]</label>
                        <div class="col-sm-6 control_padding">
                            @*<SfTextBox @ref="AbteilungID" Placeholder="@Localizer["Admin_UsersIsApprovedLabel"]" Value="@AbteilungValue">
                                </SfTextBox>*@
                        </div>
                    </div>
                </div>

                @*<div class="row ml-1 row_padding">
                        <hr style="background-color: #ABC3D7;height:1px;width:100%" />
                    </div>*@

                @*<div class="row ml-3 row_padding">
                        <div class="col-sm-12 form-inline control_padding">
                            <div class="col-sm-12 control_padding">

                                <SfButton CssClass="e-flat e-hcm-custom-btn col-sm-2" IconCss="e-icons-hcm e-hcm-save" Content="@Localizer["Button_Save"]" @onclick="onUpdateUserInfo_Click"></SfButton>
                            </div>
                        </div>
                    </div>*@

                <div class="container">
                    <div class="row mt-3 mb-4">
                        <div class="col-sm-12 top_blue_bg">
                            <div class="col-sm-12 form-inline control_padding">
                                <SfButton CssClass="e-flat e-hcm-custom-btn col-sm-2" IconCss="e-icons-hcm e-hcm-save" Content="@Localizer["Button_Save"]" @onclick="onUpdateUserInfo_Click"></SfButton>
                            </div>

                        </div>
                    </div>
                </div>

                <h4 class="blue_bg mt-3 subtitle">@Localizer["Admin_UsersChangePassowrdTitle"]</h4>

                <EditForm Model="@_HCMChangePassword" OnValidSubmit="onUpdatePassword_Click">
                    <DataAnnotationsValidator />
                    <div class="row ml-3 row_padding">
                        <div class="col-sm-12 form-inline control_padding">
                            <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_UsersNewPassowrdLabel"]</label>
                            <div class="col-sm-4 control_padding">
                                <SfTextBox @ref="Password1ID" Placeholder="@Localizer["Admin_UsersNewPassowrdLabel"]" @bind-Value="_HCMChangePassword.Password1Value">
                                </SfTextBox>
                            </div>
                            <div class="col-md-5 profilWizadrdText"><ValidationMessage For="@(() => _HCMChangePassword.Password1Value)" /> </div>
                        </div>
                    </div>

                    <div class="row ml-3 row_padding">
                        <div class="col-sm-12 form-inline control_padding">
                            <label class="col-sm-3 control_padding mylabel-left">@Localizer["Admin_UsersPassowrdConfirmLabel"]</label>
                            <div class="col-sm-4 control_padding">
                                <SfTextBox @ref="Password2ID" Placeholder="@Localizer["Admin_UsersPassowrdConfirmLabel"]" @bind-Value="_HCMChangePassword.Password2Value">
                                </SfTextBox>
                            </div>
                            <div class="col-md-5 profilWizadrdText"><ValidationMessage For="@(() => _HCMChangePassword.Password1Value)" /> </div>
                        </div>
                    </div>


                    <div class="container">
                        <div class="row mt-3 mb-4">
                            <div class="col-sm-12 top_blue_bg">
                                <div class="col-sm-12 form-inline control_padding">
                                    <SfButton CssClass="e-flat e-hcm-custom-btn col-sm-2" Type="submit" IsPrimary="true" IconCss="e-icons-hcm e-hcm-save" Content="@Localizer["Button_Save"]"></SfButton>
                                </div>

                            </div>
                        </div>
                    </div>

                </EditForm>

                <h4 class="blue_bg mt-1 subtitle">@Localizer["Admin_EditUsers_RoleList"]</h4>

                <SfGrid DataSource="@UsersRoleList" AllowPaging="false" AllowResizing="false" AllowTextWrap="true">
                    <GridEvents TValue="UserRolesModel"></GridEvents>
                    <GridColumns>
                        <GridColumn Field=@nameof(UserRolesModel.LocalizerRoleName) TextAlign="Syncfusion.Blazor.Grids.TextAlign.Left" Width="160"></GridColumn>

                    </GridColumns>
                </SfGrid>

            </div>
        </Content>


    </DialogTemplates>

    <DialogEvents OnOpen="@EditDialogBeforeOpen"></DialogEvents>
    @*<DialogAnimationSettings Effect="@DialogEffect.None"></DialogAnimationSettings>*@
</SfDialog>

@code {

    private List<UsersModel> UsersList { get; set; }
    private bool EditDialogVisibility { get; set; } = false;
    SfDialog EditDialogID;
    private string EditDialogHeader { get; set; }

    SfTextBox UserNameID;
    SfTextBox RealNameID;
    SfTextBox EMailID;
    SfTextBox AbteilungID;

    SfTextBox Password1ID;
    SfTextBox Password2ID;

    HCMChangePassword _HCMChangePassword = new HCMChangePassword();

    public class HCMChangePassword
    {
        [Required(ErrorMessageResourceName = "Admin_UsersMsgPassConfirmFailure", ErrorMessageResourceType = typeof(HcmRes))]
        [MinLength(3, ErrorMessageResourceName = "Admin_UsersMsgPassConfirmFailure", ErrorMessageResourceType = typeof(HcmRes))]
        public string Password1Value { get; set; }
        [Required(ErrorMessageResourceName = "Admin_UsersMsgPassConfirmFailure", ErrorMessageResourceType = typeof(HcmRes))]
        [MinLength(3, ErrorMessageResourceName = "Admin_UsersMsgPassConfirmFailure", ErrorMessageResourceType = typeof(HcmRes))]
        [Compare("Password1Value", ErrorMessageResourceName = "Admin_UsersMsgPassConfirmFailure", ErrorMessageResourceType = typeof(HcmRes))]
        public string Password2Value { get; set; }
    }

    //public class CustomValidationAttribute : ValidationAttribute
    //{
    //    public string ValidPassword { get; set; }

    //    protected override ValidationResult IsValid(object password, ValidationContext validationContext)
    //    {
    //        var content = password.ToString().ToLower();
    //        if (content.Equals(ValidPassword.ToLower()))
    //        {
    //            return null;
    //        }
    //        return new ValidationResult(ErrorMessage, new[] { validationContext.MemberName });
    //    }
    //}


    private List<UserRolesModel> UsersRoleList { get; set; }
    UsersModel _userInfo;
    UsersModel _editUserInfo;

    protected override async Task OnInitializedAsync()
    {
        _userInfo = await _storageService.GetItemAsync<UsersModel>("User");
        UsersList = await _usersData.UsersList(_userInfo.UserID);
        //_HCMChangePassword = new HCMChangePassword();
    }
    async Task onUpdateUserInfo_Click()
    {

    }
    async Task onUpdatePassword_Click()
    {
        //await _usersData.ChangePassword()
    }
    private void BindUsersRoleList()
    {
        UsersRoleList = _userRolesData.GetLocalizatedNames();
        foreach (UserRolesModel r in UsersRoleList)
        {
            r.LocalizerRoleName = Localizer["UserRole_" + r.RoleID.ToString()];
        }
    }
    //public void UsersList_OnCommandClicked(CommandClickEventArgs<UsersModel> args)
    //{
    //    if (args.CommandColumn.Type == CommandButtonType.Edit)
    //    {
    //        this.EditDialogVisibility = true;
    //        UserNameValue = args.RowData.LoginName;
    //        RealNameValue = args.RowData.Name;
    //        EMailValue = args.RowData.EMail;
    //        AbteilungValue = args.RowData.FunctionInFirma;
    //        BindUsersRoleList();

    //    }
    //    if (args.CommandColumn.Type == CommandButtonType.Delete)
    //    {
    //        // Perform required operations here
    //    }
    //}

    public void EditUser(UsersModel model)
    {
        this.EditDialogVisibility = true;
        _editUserInfo = model;
        _HCMChangePassword = new HCMChangePassword();
        BindUsersRoleList();
    }
    public void DeleteUser(UsersModel model)
    {

    }

    private void EditDialogBeforeOpen(BeforeOpenEventArgs args)
    {
        args.MaxHeight = null;
    }



}
